<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.reservation.dao.ReviewDao">
	<!-- 새리뷰 작성 -->
	<insert id="createReview">
		insert into review (reviewId,business_regi_num,reviewContent,reviewName,reviewGroup)
		values(reviewId.nextval,#{business_regi_num},#{reviewContent},#{reviewName},reviewId.currval)
	</insert>
	<!-- 해당 업체의 리뷰 페이징처리 -->
	<select id="reviewList" resultType="ReviewDto">
		<![CDATA[select *from review where business_regi_num=#{business_regi_num} and reviewDelete='N' order by reviewGroup asc,reviewStep asc offset (#{pm.page}-1) * #{pm.perPageNum} rows fetch next #{pm.perPageNum} rows only]]>	
	</select>
	<!-- 리뷰수정 -->
	<update id="updateReview">
		update review set reviewContent=#{reviewContent},reviewUpdateTime=SYSDATE where reviewId=#{reviewId}
	</update>
	<!-- 리뷰삭제 -->
	<update id="deleteReview">
		delete review set reviewDelete='Y' where review=#{reviewId}
	</update>
	<!-- 리뷰 답글작성 -->
	<insert id="reviewReply">
		insert into review(reviewId,business_regi_num,reviewContent,reviewName,reviewGroup,reviewStep,reviewIndent)
		values (reviewId.nextval,#{business_regi_num},#{reviewContent},#{reviewName},(select reviewGroup from review where reviewId=#{reviewId}),#{reviewStep},#{reviewIndent})
	</insert>
	<!-- 댓글 달기 전 부모의 step보다 높은 글들의 step 하나씩 증가시킴 (중간에 댓글을 삽입하기 위함) -->
	<update id="reviewStep">
		update review set reviewStep=reviewStep+1 where reviewGroup=#{reviewGroup} and reviewStep>#{reviewStep}
	</update>
	<!-- 리뷰 정보 가져오기 -->
	<select id="readReview" resultType="ReviewDto">
		select * from review where reviewId=#{reviewId}
	</select>
	<!-- 해당 업체의 리뷰 count -->
	<select id ="replyCount" resultType="int">
		<![CDATA[select count(reviewId) from review where business_regi_num=#{business_regi_num} and reviewDelete='N']]>
	</select>
</mapper>